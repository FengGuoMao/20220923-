/*
 * 取软件需求中评审时间节点到当前时间节点的时长大于7天；超期未完成；两种情况作为软件超期标准，不进行历史数据的展示。
 * 审核时间超过七天的
版本控制v1.3
 时间2022/6/17更新  增加reqestid排除项 5059 5060 5061 5062 郑增加logtyp排除项t 增加日期排除项 只取近30天数据
 */
 SELECT COUNT(REQUESTID) AS value
 from(
 select  a.NODEID
 ,b.NODENAME
 ,a.*
 from WF.WORKFLOW_REQUESTLOG AS a
 LEFT JOIN wf.WORKFLOW_NODEBASE AS b
 ON a.NODEID = b.id
 where a.WORKFLOWID = 573
 AND a.NODEID  = 5058
 AND LOGTYPE NOT IN ('3','5','e','t')
 AND DESTNODEID <>   0
 AND a.REQUESTID NOT IN (SELECT REQUESTID FROM  WF.WORKFLOW_REQUESTLOG WHERE NODEID >='5059')
 AND  timestamp(timestamp(OPERATEDATE)+7 day) < current date
 AND days(current date) - DAYS(OPERATEDATE) < 30
 )

-- 版本2
/*
 * 版本控制:
 * v1.3 冯国茂   初创 2022/09/27
 * v1.2 冯国茂   修改取50天内数据 超过的数据默认舍弃  2022/06/17
 * 待完善事宜
-- 1. 目前的数量缺少截至当前时间还未完成的CSR需求是否超期的判断.
 */
SELECT
DISTINCT demo.csr_bianhao
, HRMRESOURCE.LASTNAME
, demo.CSR_TITLE
FROM
(SELECT
a.REQUESTID
,a.OPERATEDATE
,b.REQUESTID
,b.CSR_BIANHAO
,b.CSR_TITLE
,b.CSR_ITADVISOR
,b.CSR_CESHIWCRQ
,b.CSR_CHENGNUOWCTIME
,b.CSR_KAIFAWANC
,b.CSR_CENGLWCSJ
,b.CSR_CENGLWCSJ
FROM (
	SELECT
		REQUESTID
		,OPERATEDATE
		,NODEID
	FROM WF.WORKFLOW_REQUESTLOG
	WHERE REQUESTID IN (
		SELECT
		DISTINCT REQUESTID
		 FROM WF.FORMTABLE_MAIN_37 fm
 		 WHERE  REQUESTID IN (
  			SELECT   DISTINCT REQUESTID
  			FROM WF.WORKFLOW_REQUESTLOG
			where WORKFLOWID = 573
			AND OPERATEDATE > '2022-06-07'
						 )
	 AND  CSR_CESHIWCRQ = ''
) AND NODEID = '5062'
--AND REQUESTID
) AS a
INNER JOIN  WF.FORMTABLE_MAIN_37 AS b
ON a.REQUESTID = b.REQUESTID
WHERE a.OPERATEDATE > b.CSR_CHENGNUOWCTIME
) AS demo
LEFT JOIN WF.HRMRESOURCE AS HRMRESOURCE
ON substr(demo.CSR_ITADVISOR, 1, 4)   LIKE  HRMRESOURCE.id
UNION ALL
-- 测试主表软件类型区别
SELECT
DISTINCT
demo.csr_bianhao
,HRMRESOURCE.LASTNAME
,demo.CSR_TITLE
FROM
(SELECT
ID
,REQUESTID
,CSR_BIANHAO
,CSR_ITADVISOR
,CSR_TITLE
,CSR_CESHIWCRQ
,CSR_CHENGNUOWCTIME
,CSR_CENGLWCSJ
,CSR_KAIFAGUWENXZ
 FROM WF.FORMTABLE_MAIN_37 fm
 WHERE CSR_ITADVISOR <> 'NULL'
 AND REQUESTID IN (
  SELECT   DISTINCT REQUESTID FROM WF.WORKFLOW_REQUESTLOG
where WORKFLOWID = 573
AND OPERATEDATE > '2022-06-07'
 )
 AND CSR_CESHIWCRQ <>  ' '
 AND CSR_CHENGNUOWCTIME <> ' '
 AND CSR_CESHIWCRQ > CSR_CHENGNUOWCTIME
 ) AS demo
 LEFT JOIN WF.HRMRESOURCE AS HRMRESOURCE
ON substr(demo.CSR_ITADVISOR, 1, 4)   LIKE  HRMRESOURCE.id


-- 版本3
/*
 * 版本控制: 未完成已超期
 * v1.3 冯国茂   初创 2022/09/27
 * v1.2 冯国茂   修改取50天内数据 超过的数据默认舍弃  2022/06/17
 * 待完善事宜
-- 1. 目前的数量缺少截至当前时间还未完成的CSR需求是否超期的判断.
 */
SELECT
DISTINCT demo.csr_bianhao
, HRMRESOURCE.LASTNAME
, demo.CSR_TITLE
FROM
(select
CSR_CHENGNUOWCTIME
,b.REQUESTID
,b.CSR_BIANHAO
,b.CSR_TITLE
,b.CSR_ITADVISOR
,b.CSR_CESHIWCRQ
,b.CSR_CHENGNUOWCTIME
,b.CSR_KAIFAWANC
,b.CSR_CENGLWCSJ
,b.CSR_CENGLWCSJ
from WF.FORMTABLE_MAIN_37 b
inner join (select * from WF.workflow_requestbase where WORKFLOWID =573) e
on b.REQUESTID = e.REQUESTID
where SQLX <2
and  length(replace(CSR_CeshiWCRQ,' ',''))=0
and length(replace(CSR_CHENGNUOWCTIME,' ',''))>0
and e.currentnodetype<>3
and  date(CSR_CHENGNUOWCTIME)<current date
) AS demo
LEFT JOIN WF.HRMRESOURCE AS HRMRESOURCE
ON demo.CSR_ITADVISOR = CHAR(HRMRESOURCE.id)